{"version":3,"sources":["webpack://window-bus/./node_modules/tiny-emitter/index.js","webpack://window-bus/./index.ts","webpack://window-bus/webpack/bootstrap","webpack://window-bus/./test/client.ts"],"names":[],"mappings":";;;;;;;;;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA,kCAAkC;;AAElC;AACA;AACA;AACA,KAAK;;AAEL;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA;AACA,yCAAyC;AACzC;AACA;;AAEA,WAAW,SAAS;AACpB;AACA;;AAEA;AACA,GAAG;;AAEH;AACA,kCAAkC;AAClC;AACA;;AAEA;AACA,wCAAwC,SAAS;AACjD;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,0BAA0B;;;;;;;;;;;;AClEb;AACb,8CAA6C,CAAC,cAAc,EAAC;AAC7D,qBAAqB,mBAAO,CAAC,0DAAc;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iEAAiE,8BAA8B,EAAE;AACjG,yBAAyB;AACzB;AACA;AACA,yBAAyB;AACzB;AACA,yBAAyB;AACzB;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA,4CAA4C,qCAAqC,EAAE;AACnF;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,SAAS;AACT;AACA;AACA,kCAAkC,kBAAkB;AACpD,kEAAkE,eAAe;AACjF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qEAAqE,oBAAoB,EAAE;AAC3F;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD,eAAe;;;;;;;UCrGf;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;;;;;;;;ACtBa;AACb,8CAA6C,CAAC,cAAc,EAAC;AAC7D,cAAc,mBAAO,CAAC,4BAAU;AAChC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,SAAS;AACT,KAAK;AACL;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA,SAAS;AACT;AACA","file":"client.js","sourcesContent":["function E () {\n  // Keep this empty so it's easier to inherit from\n  // (via https://github.com/lipsmack from https://github.com/scottcorgan/tiny-emitter/issues/3)\n}\n\nE.prototype = {\n  on: function (name, callback, ctx) {\n    var e = this.e || (this.e = {});\n\n    (e[name] || (e[name] = [])).push({\n      fn: callback,\n      ctx: ctx\n    });\n\n    return this;\n  },\n\n  once: function (name, callback, ctx) {\n    var self = this;\n    function listener () {\n      self.off(name, listener);\n      callback.apply(ctx, arguments);\n    };\n\n    listener._ = callback\n    return this.on(name, listener, ctx);\n  },\n\n  emit: function (name) {\n    var data = [].slice.call(arguments, 1);\n    var evtArr = ((this.e || (this.e = {}))[name] || []).slice();\n    var i = 0;\n    var len = evtArr.length;\n\n    for (i; i < len; i++) {\n      evtArr[i].fn.apply(evtArr[i].ctx, data);\n    }\n\n    return this;\n  },\n\n  off: function (name, callback) {\n    var e = this.e || (this.e = {});\n    var evts = e[name];\n    var liveEvents = [];\n\n    if (evts && callback) {\n      for (var i = 0, len = evts.length; i < len; i++) {\n        if (evts[i].fn !== callback && evts[i].fn._ !== callback)\n          liveEvents.push(evts[i]);\n      }\n    }\n\n    // Remove event from queue to prevent memory leak\n    // Suggested by https://github.com/lazd\n    // Ref: https://github.com/scottcorgan/tiny-emitter/commit/c6ebfaa9bc973b33d110a84a307742b7cf94c953#commitcomment-5024910\n\n    (liveEvents.length)\n      ? e[name] = liveEvents\n      : delete e[name];\n\n    return this;\n  }\n};\n\nmodule.exports = E;\nmodule.exports.TinyEmitter = E;\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tiny_emitter_1 = require(\"tiny-emitter\");\nvar WindowBus = (function () {\n    function WindowBus(targetWindow, origin, channel) {\n        var _this = this;\n        this.emitter = new tiny_emitter_1.TinyEmitter();\n        this.frame = null;\n        this.origin = null;\n        this.id = 1;\n        this.queue = {};\n        this.channel = 'window-bus';\n        this.chains = {};\n        this.frame = targetWindow || (window.parent !== window && window.parent);\n        if (!this.frame) {\n            throw new Error('A frame is required');\n        }\n        if (channel) {\n            this.setChannel(channel);\n        }\n        this.origin = origin || this.frame.location.origin;\n        window.addEventListener(\"message\", function (event) {\n            if (event.origin !== _this.origin)\n                return;\n            try {\n                var data_1 = typeof event.data === \"object\" ? event.data : JSON.parse(event.data);\n                if (data_1.target === _this.channel && data_1.id) {\n                    if (data_1.reply === true && _this.queue[data_1.id]) {\n                        _this.queue[data_1.id][data_1.error ? 'reject' : 'resolve'](data_1.payload);\n                        delete _this.queue[data_1.id];\n                    }\n                    else if (data_1.reply !== true) {\n                        var chain_1 = Promise.resolve(data_1.payload);\n                        _this.emitter.emit(data_1.action, function (cb) {\n                            chain_1 = chain_1.then(function (v) { return cb(v, data_1.payload); });\n                        });\n                        chain_1.then(function (payload) {\n                            _this.reply(event, data_1.id, payload);\n                        }, function (payload) {\n                            _this.reply(event, data_1.id, payload, true);\n                        });\n                    }\n                }\n            }\n            catch (e) {\n            }\n        });\n    }\n    WindowBus.prototype.setChannel = function (channel) {\n        this.channel = channel;\n    };\n    WindowBus.prototype.reply = function (event, id, payload, error) {\n        event.source.postMessage({\n            reply: true,\n            target: this.channel,\n            id: id,\n            payload: payload,\n            error: error,\n        }, event.origin);\n    };\n    WindowBus.prototype.dispatch = function (action, payload) {\n        var _this = this;\n        return new Promise(function (resolve, reject) {\n            var t = setTimeout(function () { return reject(new Error('timeout')); }, 30000);\n            _this.queue[_this.id] = {\n                resolve: function (args) {\n                    clearTimeout(t);\n                    resolve(args);\n                },\n                reject: reject\n            };\n            _this.frame.postMessage({\n                action: action,\n                target: _this.channel,\n                id: _this.id++,\n                payload: payload,\n            }, _this.frame.location.origin);\n        });\n    };\n    WindowBus.prototype.chainWrap = function (fn, action, cb) {\n        var c = function (chain) { return chain(cb); };\n        (this.chains[action] || (this.chains[action] = [])).push({ cb: cb, c: c });\n        this.emitter[fn](action, c);\n    };\n    WindowBus.prototype.on = function (action, cb) {\n        this.chainWrap('on', action, cb);\n    };\n    WindowBus.prototype.once = function (action, cb) {\n        this.chainWrap('once', action, cb);\n    };\n    WindowBus.prototype.off = function (action, cb) {\n        if (cb) {\n            var res = (this.chains[action] || []).find(function (v) { return v.cb === cb; });\n            if (res) {\n                cb = res.c;\n            }\n        }\n        this.emitter.off(action, cb);\n    };\n    return WindowBus;\n}());\nexports.default = WindowBus;\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar index_1 = require(\"../index\");\nwindow.startClient = function (iframe) {\n    var bus = new index_1.default(iframe.contentWindow);\n    bus.setChannel('demo');\n    var pre = document.getElementsByTagName('pre')[0];\n    var display = function (res) {\n        pre.append(document.createTextNode(JSON.stringify(res)));\n        pre.append(document.createElement('br'));\n    };\n    bus.dispatch('test', {\n        somePayload: true\n    }).then(function (res) {\n        display(res);\n        return bus.dispatch('test', {\n            another: 'payload'\n        });\n    }).then(display);\n    bus.on('print', function (msg) {\n        display(msg);\n        return \"reply from the client\";\n    });\n    bus.dispatch('otherTest', 'hi').then(function (res) {\n        display(res);\n        return bus.dispatch('otherTest', 'hi again');\n    }).then(display);\n    var text = document.getElementsByTagName('textarea')[0];\n    text.addEventListener('input', function () {\n        bus.dispatch('change', text.value);\n    });\n    bus.on('change', function (value) {\n        text.value = value;\n    });\n};\nwindow.openPopup = function () {\n    var win = window.open('server.html', 'example', 'width=300,height=300');\n    win.onload = function () {\n        var bus = new index_1.default(win);\n        bus.setChannel('demo-2');\n        var text = document.getElementsByTagName('textarea')[0];\n        bus.dispatch('change', text.value);\n        text.addEventListener('input', function () {\n            bus.dispatch('change', text.value);\n        });\n        bus.on('change', function (value) {\n            if (text.value !== value) {\n                text.value = value;\n            }\n        });\n    };\n};\n"],"sourceRoot":""}