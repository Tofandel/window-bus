{"version":3,"sources":["webpack://window-bus/./node_modules/tiny-emitter/index.js","webpack://window-bus/./index.ts","webpack://window-bus/./test/server.ts","webpack://window-bus/webpack/bootstrap","webpack://window-bus/webpack/startup"],"names":[],"mappings":";;;;;;;;;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA,kCAAkC;;AAElC;AACA;AACA;AACA,KAAK;;AAEL;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,GAAG;;AAEH;AACA;AACA,yCAAyC;AACzC;AACA;;AAEA,WAAW,SAAS;AACpB;AACA;;AAEA;AACA,GAAG;;AAEH;AACA,kCAAkC;AAClC;AACA;;AAEA;AACA,wCAAwC,SAAS;AACjD;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,0BAA0B;;;;;;;;;;;;AClEb;AACb,8CAA6C,CAAC,cAAc,EAAC;AAC7D,qBAAqB,mBAAO,CAAC,0DAAc;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iEAAiE,8BAA8B,EAAE;AACjG,yBAAyB;AACzB;AACA;AACA,yBAAyB;AACzB;AACA,yBAAyB;AACzB;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,SAAS;AACT;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA,4CAA4C,qCAAqC,EAAE;AACnF;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,SAAS;AACT;AACA;AACA,kCAAkC,kBAAkB;AACpD,kEAAkE,eAAe;AACjF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qEAAqE,oBAAoB,EAAE;AAC3F;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD,eAAe;;;;;;;;;;;;ACzJF;AACb;AACA;AACA,gDAAgD,OAAO;AACvD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8CAA6C,CAAC,cAAc,EAAC;AAC7D,cAAc,mBAAO,CAAC,4BAAU;AAChC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,SAAS;AACT,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA,qCAAqC;AACrC,wCAAwC,oCAAoC,SAAS,gBAAgB,GAAG,EAAE;AAC1G,aAAa,EAAE;AACf;AACA;AACA;AACA;AACA,2CAA2C,SAAS,gBAAgB;AACpE,aAAa;AACb;AACA;AACA;AACA;AACA,qBAAqB;AACrB,iBAAiB;AACjB;AACA,aAAa;AACb,SAAS;AACT;AACA;AACA;AACA;AACA;;;;;;;UCpEA;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;UCtBA;UACA;UACA;UACA","file":"server.js","sourcesContent":["function E () {\n  // Keep this empty so it's easier to inherit from\n  // (via https://github.com/lipsmack from https://github.com/scottcorgan/tiny-emitter/issues/3)\n}\n\nE.prototype = {\n  on: function (name, callback, ctx) {\n    var e = this.e || (this.e = {});\n\n    (e[name] || (e[name] = [])).push({\n      fn: callback,\n      ctx: ctx\n    });\n\n    return this;\n  },\n\n  once: function (name, callback, ctx) {\n    var self = this;\n    function listener () {\n      self.off(name, listener);\n      callback.apply(ctx, arguments);\n    };\n\n    listener._ = callback\n    return this.on(name, listener, ctx);\n  },\n\n  emit: function (name) {\n    var data = [].slice.call(arguments, 1);\n    var evtArr = ((this.e || (this.e = {}))[name] || []).slice();\n    var i = 0;\n    var len = evtArr.length;\n\n    for (i; i < len; i++) {\n      evtArr[i].fn.apply(evtArr[i].ctx, data);\n    }\n\n    return this;\n  },\n\n  off: function (name, callback) {\n    var e = this.e || (this.e = {});\n    var evts = e[name];\n    var liveEvents = [];\n\n    if (evts && callback) {\n      for (var i = 0, len = evts.length; i < len; i++) {\n        if (evts[i].fn !== callback && evts[i].fn._ !== callback)\n          liveEvents.push(evts[i]);\n      }\n    }\n\n    // Remove event from queue to prevent memory leak\n    // Suggested by https://github.com/lazd\n    // Ref: https://github.com/scottcorgan/tiny-emitter/commit/c6ebfaa9bc973b33d110a84a307742b7cf94c953#commitcomment-5024910\n\n    (liveEvents.length)\n      ? e[name] = liveEvents\n      : delete e[name];\n\n    return this;\n  }\n};\n\nmodule.exports = E;\nmodule.exports.TinyEmitter = E;\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tiny_emitter_1 = require(\"tiny-emitter\");\nvar WindowBus = (function () {\n    function WindowBus(targetWindow, origin, channel) {\n        var _this = this;\n        this.emitter = new tiny_emitter_1.TinyEmitter();\n        this.frame = null;\n        this._client = null;\n        this._server = null;\n        this.serverReady = true;\n        this.origin = null;\n        this.id = 1;\n        this.queue = {};\n        this.channel = 'window-bus';\n        this.chains = {};\n        this.frame = targetWindow || (window.parent !== window && window.parent);\n        if (!this.frame) {\n            throw new Error('A frame is required');\n        }\n        if (channel) {\n            this.setChannel(channel);\n        }\n        this.origin = origin || document.referrer;\n        if (this.origin) {\n            this.origin = new URL(this.origin).origin;\n        }\n        else {\n            this.origin = document.location.origin;\n        }\n        window.addEventListener(\"message\", function (event) {\n            if (_this.serverReady && event.origin !== _this.origin)\n                return;\n            try {\n                var data_1 = typeof event.data === \"object\" ? event.data : JSON.parse(event.data);\n                if (typeof data_1 === \"object\" && data_1.target === _this.channel && data_1.id) {\n                    if (data_1.reply === true && _this.queue[data_1.id]) {\n                        _this.queue[data_1.id][data_1.error ? 'reject' : 'resolve'](data_1.payload);\n                        delete _this.queue[data_1.id];\n                    }\n                    else if (data_1.reply !== true) {\n                        var chain_1 = Promise.resolve(data_1.payload);\n                        _this.emitter.emit(data_1.action, function (cb) {\n                            chain_1 = chain_1.then(function (v) { return cb(v, data_1.payload); });\n                        });\n                        chain_1.then(function (payload) {\n                            _this.reply(event, data_1.id, payload);\n                        }, function (payload) {\n                            _this.reply(event, data_1.id, payload, true);\n                        });\n                    }\n                }\n            }\n            catch (e) {\n            }\n        });\n    }\n    WindowBus.prototype.startClient = function (payload) {\n        if (this._client) {\n            throw new Error('Client already started');\n        }\n        return this._client = this.dispatch('bus-handshake', {\n            payload: payload,\n            origin: document.location.origin,\n        });\n    };\n    Object.defineProperty(WindowBus.prototype, \"client\", {\n        get: function () {\n            return this._client;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    WindowBus.prototype.startServer = function () {\n        var _this = this;\n        if (this._server) {\n            throw new Error('Server already started');\n        }\n        this.serverReady = false;\n        return this._server = new Promise(function (resolve, reject) {\n            var t = setTimeout(function () {\n                reject(new Error('Window bus timed out, did you forget to startClient?'));\n            }, 10000);\n            _this.once('bus-handshake', function (_a) {\n                var origin = _a.origin, payload = _a.payload;\n                _this.origin = origin;\n                _this.serverReady = true;\n                clearTimeout(t);\n                resolve(payload);\n                return payload;\n            });\n        });\n    };\n    Object.defineProperty(WindowBus.prototype, \"server\", {\n        get: function () {\n            return this._client;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    WindowBus.prototype.setChannel = function (channel) {\n        this.channel = channel;\n    };\n    WindowBus.prototype.reply = function (event, id, payload, error) {\n        event.source.postMessage({\n            reply: true,\n            target: this.channel,\n            id: id,\n            payload: payload,\n            error: error,\n        }, event.origin);\n    };\n    WindowBus.prototype.dispatch = function (action, payload) {\n        var _this = this;\n        return new Promise(function (resolve, reject) {\n            var t = setTimeout(function () { return reject(new Error('timeout')); }, 30000);\n            _this.queue[_this.id] = {\n                resolve: function (args) {\n                    clearTimeout(t);\n                    resolve(args);\n                },\n                reject: reject\n            };\n            _this.frame.postMessage({\n                action: action,\n                target: _this.channel,\n                id: _this.id++,\n                payload: payload,\n            }, _this.origin);\n        });\n    };\n    WindowBus.prototype.chainWrap = function (fn, action, cb) {\n        var c = function (chain) { return chain(cb); };\n        (this.chains[action] || (this.chains[action] = [])).push({ cb: cb, c: c });\n        this.emitter[fn](action, c);\n    };\n    WindowBus.prototype.on = function (action, cb) {\n        this.chainWrap('on', action, cb);\n    };\n    WindowBus.prototype.once = function (action, cb) {\n        this.chainWrap('once', action, cb);\n    };\n    WindowBus.prototype.off = function (action, cb) {\n        if (cb) {\n            var res = (this.chains[action] || []).find(function (v) { return v.cb === cb; });\n            if (res) {\n                cb = res.c;\n            }\n        }\n        this.emitter.off(action, cb);\n    };\n    return WindowBus;\n}());\nexports.default = WindowBus;\n","\"use strict\";\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar index_1 = require(\"../index\");\nif (window.opener) {\n    var bus_1 = new index_1.default(window.opener);\n    bus_1.setChannel('demo-2');\n    bus_1.startServer().then(function () {\n        var text = document.getElementsByTagName('textarea')[0];\n        text.addEventListener('input', function () {\n            bus_1.dispatch('change', text.value);\n        });\n        bus_1.on('change', function (value) {\n            text.value = value;\n        });\n    });\n}\nelse {\n    try {\n        var bus_2 = new index_1.default();\n        bus_2.setChannel('demo');\n        bus_2.startServer().then(function () {\n            var text = document.getElementsByTagName('textarea')[0];\n            text.addEventListener('input', function () {\n                bus_2.dispatch('change', text.value);\n            });\n            bus_2.on('change', function (value) {\n                if (text.value !== value) {\n                    text.value = value;\n                }\n            });\n            var pre = document.getElementsByTagName('pre')[0];\n            var display = function (res) {\n                pre.append(document.createTextNode(JSON.stringify(res)));\n                pre.append(document.createElement('br'));\n            };\n            var cb = function (res) { return new Promise(function (resolve) {\n                setTimeout(function () { return resolve(__assign(__assign({}, res), { result1: true })); }, 100);\n            }); };\n            bus_2.on('test', cb);\n            bus_2.on('test', function (res, original) {\n                bus_2.off('test', cb);\n                display(original);\n                return __assign(__assign({}, res), { result2: true });\n            });\n            bus_2.once('otherTest', function (res) {\n                setTimeout(function () {\n                    bus_2.dispatch('print', 'sent from the server').then(function (msg) {\n                        display(msg);\n                    });\n                }, 100);\n                return res + ' for the first time';\n            });\n        });\n    }\n    catch (e) {\n        document.body.append(document.createTextNode(e.toString()));\n    }\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(\"./test/server.ts\");\n"],"sourceRoot":""}